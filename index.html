<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WEB問診 - 三鷹ヒロクリニック</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hiragino Sans', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 32px 24px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    .clinic-name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    .title {
      font-size: 14px;
      color: #666;
      margin-bottom: 24px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #1a73e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .status {
      font-size: 14px;
      color: #888;
      margin-bottom: 16px;
    }
    .error {
      color: #d32f2f;
      font-size: 14px;
      margin-top: 16px;
      display: none;
    }
    .fallback-btn {
      display: none;
      margin-top: 16px;
      padding: 12px 24px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <p class="clinic-name">三鷹ヒロクリニック</p>
    <p class="title">WEB問診</p>
    <div class="spinner" id="spinner"></div>
    <p class="status" id="status">LINE情報を取得中...</p>
    <p class="error" id="error"></p>
    <a class="fallback-btn" id="fallback" href="">LINE連携なしで問診へ進む</a>
  </div>

  <script>
    var LIFF_ID = "2009216510-et7pm1CV";

    var FORM_PREFILL_URL = "https://docs.google.com/forms/d/e/1FAIpQLSesAUm5Im3grZfIa475ImMM7dIQ6gC8Gfj8tsGT8EaOaxWQKQ/viewform?usp=pp_url&entry.483974235=";

    var GAS_URL = "https://script.google.com/macros/s/AKfycbwwirFLAu3J9rGXziJq3XuxVPqoM5Iee7mIRMy9lJizYNXke9SUHnvrB57wE5kGcURZ/exec";

    var statusEl = document.getElementById("status");
    var errorEl = document.getElementById("error");
    var spinnerEl = document.getElementById("spinner");
    var fallbackEl = document.getElementById("fallback");

    fallbackEl.href = FORM_PREFILL_URL.split("?")[0];

    function generateToken() {
      var now = new Date();
      var dateStr = now.getFullYear().toString() +
        ("0" + (now.getMonth() + 1)).slice(-2) +
        ("0" + now.getDate()).slice(-2) +
        ("0" + now.getHours()).slice(-2) +
        ("0" + now.getMinutes()).slice(-2) +
        ("0" + now.getSeconds()).slice(-2);
      var rand = Math.random().toString(36).substring(2, 6).toUpperCase();
      return "R" + dateStr + rand;
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          statusEl.textContent = "LINEログイン中...";
          liff.login();
          return;
        }

        statusEl.textContent = "ユーザー情報を取得中...";
        var profile = await liff.getProfile();
        var userId = profile.userId;
        var displayName = profile.displayName;
        var token = generateToken();

        statusEl.textContent = "問診フォームを開いています...";
        fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "type=line_register"
            + "&token=" + encodeURIComponent(token)
            + "&userId=" + encodeURIComponent(userId)
            + "&displayName=" + encodeURIComponent(displayName),
          mode: "no-cors"
        }).catch(function(){});

        liff.openWindow({
          url: FORM_PREFILL_URL + encodeURIComponent(token),
          external: true
        });
        liff.closeWindow();

      } catch (err) {
        spinnerEl.style.display = "none";
        statusEl.textContent = "";
        errorEl.style.display = "block";
        errorEl.textContent = "LINE連携に失敗しました: " + err.message;
        fallbackEl.style.display = "inline-block";
      }
    }

    initLiff();
  </script>
</body>
</html>
